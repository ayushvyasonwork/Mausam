name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: [self-hosted, linux]

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: npm
        cache-dependency-path: |
          Client/package-lock.json
          Server/package-lock.json

    # ---------- CLIENT ----------
    - name: Install Client dependencies
      run: |
        cd Client
        npm ci

    - name: Lint Client
      run: |
        cd Client
        npm run lint

    - name: Build Client
      run: |
        cd Client
        npm run build

    - name: Archive production artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-${{ matrix.node-version }}
        path: Client/dist/
        retention-days: 7
    
    - name: Deploy frontend to Nginx
      run: |
        sudo rm -rf /var/www/html/*
        sudo cp -r Client/dist/* /var/www/html/

    # ---------- SERVER ----------
    - name: Install Server dependencies
      run: |
        cd Server
        npm ci

    - name: Run Server with env
      run: |
        cd Server
        npm test || echo "No tests found"
    
    - name: Create backend .env file 
      working-directory: ./Server
      run: |
        touch .env
        echo "${{secrets.PROD_BACKEND_ENV}}" >> .env
      
    - name: Start backend with PM2
      working-directory: ./Server
      run: |
        /home/ubuntu/.nvm/versions/node/v24.12.0/bin/pm2 restart backend || /home/ubuntu/.nvm/versions/node/v24.12.0/bin/pm2 start index.js --name backend
